# 简介
在开发中，要晓得服务器的性能如何，带宽的稳定性，我们需要测试，下面通过iper测试服务器带宽

！(iperf官网)[https://iperf.fr/]

博客
https://www.cnblogs.com/ltlinux/p/11027474.html

# iperf3 安装
## linux 安装（一般安装在服务器）
1. 下载安装包,地址可以在官网下面去找最新的
```
wget https://iperf.fr/download/source/iperf-3.1.3-source.tar.gz
```
2. 解压
```
tar -zxvf iperf-3.1.3-source.tar.gz
```

3. 编译并安装
```
cd iperf-3.1.3

./configure

make

make install
```
4. 检测是否安装成功
```
iperf3 -v 
```
如果作为服务器，则通过下面命令启动
```
iperf3 -s
```

## windows 下安装（一般用来当客服端）
1. 在下面官网地址下载对应的windows 安装包
```
https://iperf.fr/iperf-download.php
```

2. 解压后有.dll和.exe 文件，将两个文件放在没有中文目录的文件夹下
3. 打开cmd 输入下面命令（下面是作为客户端使用）
```
iperf3 -c 服务器IP地址
```

# iperf的使用方法
这里主要测试6个考量参数
1. TCP上传数据带宽
2. TCP下载数据带宽
3. UDP上传带宽
4. UDP下载带宽
5. 多并发支持
6. 稳定性

##  TCP上传数据带宽
在客服端执行命令
```
iperf3 -c [serverip] -b 100M -t 20
```

-c  代表以客户端方式运行

-b  代表使用100M带宽进行测试，如果馆方为1000M有线网络，也可以使用-b 1000M进行测试。带宽测试需要考虑客户端本机网卡能力、馆方内网能力、出口带宽、公网带宽、服务云接入带宽等。

-t  即为测试20s时间，如果省略该参数则默认测试10s。

结果上来看，上传带宽为93.8Mb/s，也就是达到了百兆左右。

这里说明的是，第一个包应为要建立tcp连接，所以传输和带宽都会略低，而第12.00-13.00传输和带宽都有所下降，说明在该秒存在明显的丢包。正常无明显丢包的测试结果应该如下：

## Tcp下载数据带宽
执行命令
```
iperf3 -c [serverip] -b 100M -t 20 -R
```
相比下载数据带宽测试多了一个-R参数，意为Reverse，即服务器端发送数据，客户端接收数据。


## UDP上传数据带宽
```
iperf3 -c [serverip] -u -b 100M -t 20
```
其中比tcp的上传数据带宽测试命令多一个-u，意为使用udp协议。

## UDP下载数据带宽
```
iperf3 -c [serverip] -u -b 100M -t 20 -R
```

## 多并发支持
```
iperf3 -c [serverip] -P 127 -i 20 -t 20
```
此处的-P是指启用多线程，127为线程数，范围为1-128，但是使用128则会引起windows端的iperf3程序崩溃，所以最多一台电脑可以模拟127个线程同时连接服务器。观察最后的统计结果，每个线程都有流量，且最后SUM为100M满速即可。

当然，-R和-u都是可以使用的，但是使用-u只能实现90个线程同时测试，超过90个线程软件最后会出现假死状态。

## 稳定性测试
```
iperf3 -c [serverip] -t 3600
```
-t 是设置时间，3600为持续测试3600s，即1小时。测试思路是可以通过增加时间来评估稳定性，如测试1小时（t的取值范围并未注明，但是10小时是可以的）。当然-P -u -R都是可选的参数。

# iperf 的命令选项

## 常规选项

| 命令行选项                     | 描述                                                         |
| ------------------------------ | ------------------------------------------------------------ |
| **-p**，--port ***n***         | 服务器用于侦听和客户端连接的服务器端口。客户端和服务器中这应该相同。默认值为5201 |
| **--cport** ***n***            | 用于指定客户端端口的选项。（iPerf 3.1中的新功能）            |
| **-f**，-- ***format [kmKM]*** | 一个字母，指定用于打印带宽数字的格式。支持的格式为 `  'k'=千比特/秒'K'=千字节/秒   'm'=兆比特/秒'M'=兆字节/秒`自适应格式可以在千和兆之间进行选择。 |
| **-i**，--interval ***n***     | 设置定期带宽，抖动和损耗报告之间的间隔时间（以秒为单位）。如果不为零，则 自上一次报告以来，每隔带宽***间隔***秒便会报告一次。如果为零，则不打印任何定期报告。默认值为零。 |
| **-F**，-文件名                | **客户端：**从文件读取并写入网络，而不是使用随机数据； **服务器端：**从网络读取并写入文件，而不是丢弃数据。 |
| **-A**，-亲和力***n / n，mF*** | 设置CPU关联（如果可能）（仅限Linux和FreeBSD）。在客户端和服务器上，都可以使用此参数的n形式（其中n是CPU编号）来设置本地亲缘关系。另外，在客户端，您可以使用n，m形式的参数来覆盖服务器仅对一项测试的亲和力。请注意，使用此功能时，一个进程将仅绑定到单个CPU（而不是包含可能的多个CPU的集合）。 |
| **-B**，--bind***主机***       | 绑定到***主机***，这台机器的地址之一。对于客户端，这将设置出站接口。对于服务器，这将设置传入接口。这仅在具有多个网络接口的多宿主主机上有用。 |
| **-V**，-冗长                  | 提供更详细的输出                                             |
| **-J**，--json                 | 以JSON格式输出                                               |
| **--logfile**文件              | 将输出发送到日志文件。（iPerf 3.1中的新功能）                |
| **--d**，-**调试**             | 发出调试输出。主要（也许专门）用于开发人员。                 |
| **-v**，--version              | 显示版本信息并退出。                                         |
| **-h**，-帮助                  | 显示帮助简介并退出。                                         |


## 服务器特定选项


| 命令行选项                  | 描述                                                         |
| --------------------------- | ------------------------------------------------------------ |
| **-s**，-服务器             | 在服务器模式下运行iPerf。（这一次仅允许一个iperf连接）       |
| **-D**，-守护进程           | 作为后台程序在后台运行服务器。                               |
| **-I**，--pidfile***文件*** | 编写具有进程ID的文件，这在作为守护程序运行时最有用。（iPerf 3.1中的新功能） |
## 客户特定选项                                       
| 命令行选项                           | 描述                                                         |
| ------------------------------------ | ------------------------------------------------------------ |
| **-c**，--client***主机***           | 运行iperf的客户端模式，连接到上运行的iperf的服务器***主机***。 |
| **--sctp**                           | 使用SCTP而不是TCP（Linux，FreeBSD和Solaris）。（iPerf 3.1中的新功能） |
| **-u**，--udp                        | 使用UDP而不是TCP。另请参见[-b](https://iperf.fr/iperf-doc.php#3bandwidth)选项。 |
| **-b**，--bandwidth ***n [KM]***     | 将目标带宽设置为n位/秒（对于UDP默认为1 Mbit /秒，对于TCP为无限制）。如果有多个流（-P标志），则带宽限制将分别应用于每个流。您也可以在带宽说明符中添加一个“ /”和一个数字。这称为“突发模式”。即使暂时超过了指定的带宽限制，它也会发送给定数量的数据包而不会暂停。 |
| **-t**，-时间***n***                 | 传输时间（以秒为单位）。iPerf通常通过重复发送***len***个字节的数组达***时间***秒来工作。默认值为10秒。另请参见[-l](https://iperf.fr/iperf-doc.php#3len)，[-k](https://iperf.fr/iperf-doc.php#3blockcount)和[-n](https://iperf.fr/iperf-doc.php#3num)选项。 |
| **-n**，--num ***n [KM]***           | 要传输的缓冲区数。通常，iPerf发送10秒。-n选项将覆盖此参数，并发送***len*** 个字节的数组，该数组***num***次，无论它花费多长时间。另请参见[-l](https://iperf.fr/iperf-doc.php#3len)，[-k](https://iperf.fr/iperf-doc.php#3blockcount)和[-t](https://iperf.fr/iperf-doc.php#3time)选项。 |
| **-k**，--blockcount ***n [KM]***    | 要传输的块（数据包）数。（而不是-t或-n）另请参阅[-t](https://iperf.fr/iperf-doc.php#3time)，[-l](https://iperf.fr/iperf-doc.php#3len)和[-n](https://iperf.fr/iperf-doc.php#3num)选项。 |
| **-l**，--length ***n [KM]***        | 读取或写入的缓冲区的长度。iPerf通过多次写入***len***个字节的数组来工作。TCP的默认值为128 KB，UDP的默认值为8 KB。另请参见[-n](https://iperf.fr/iperf-doc.php#3num)，[-k](https://iperf.fr/iperf-doc.php#3blockcount)和[-t](https://iperf.fr/iperf-doc.php#3time)选项。 |
| **-P**，-平行***n***                 | 到服务器的同时连接数。默认值为1。                            |
| **-R**，-反向                        | 以反向模式运行（服务器发送，客户端接收）。                   |
| **-w**，--window ***n [KM]***        | 将套接字缓冲区大小设置为指定值。对于TCP，这将设置TCP窗口大小。（这将发送到服务器并在该侧使用） |
| **-M**，--set-mss ***n***            | 尝试设置TCP最大段大小（MSS）。MSS通常是MTU-TCP / IP标头的40个字节。对于以太网，MSS为1460字节（1500字节MTU）。 |
| **-N**，-无延迟                      | 设置TCP no delay选项，禁用Nagle的算法。通常，仅对交互式应用程序（如telnet）禁用此功能。 |
| **-4**，--version4                   | 仅使用IPv4。                                                 |
| **-6**，--version4                   | 仅使用IPv6。                                                 |
| **-S**，--tos ***n***                | 传出数据包的服务类型。（许多路由器会忽略TOS字段。）您可以使用十六进制值（0x）作为前缀，使用八进制数（0）作为前缀，或者使用十进制来指定值。例如，'0x10'十六进制='020'八进制='16'十进制。RFC 1349中指定的TOS编号为： `  IPTOS_LOWDELAY最小化延迟0x10   IPTOS_THROUGHPUT最大化吞吐量0x08   IPTOS_RELIABILITY最大化可靠性0x04   IPTOS_LOWCOST最小化成本0x02` |
| **-L**，--flowlabel ***n***          | 设置IPv6流标签（当前仅在Linux上受支持）。                    |
| **-Z**，--zerocopy                   | 使用发送数据的“零复制”方法，例如sendfile（2），而不是通常的write（2）。这将使用更少的CPU。 |
| **-O**，-省略***n***                 | 省略测试的前n秒，以跳过TCP [TCP慢启动](https://en.wikipedia.org/wiki/Slow-start)周期。 |
| **-T，--title \**\*str\**\***        | 使用此字符串为每条输出行添加前缀。                           |
| **-C**，--linux-congestion***算法*** | 设                                                           |

# 安装错误解决
## 错误信息
```
iperf3: error while loading shared libraries: libiperf.so.0: cannot open shared object file: No such file or directory
```
这个问题容易发生在centos6 和Ubuntu较老版本上:
编译错误.

### 解决方法:
在正常编译后运行.
```
ldconfig
```

