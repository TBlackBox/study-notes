# ç®€ä»‹
æœ¬æ–‡é…ç½®SpringBootçš„3ç§ä»»åŠ¡ï¼Œå¼‚æ­¥ä»»åŠ¡ï¼Œå®šæ—¶ä»»åŠ¡ï¼Œé‚®ä»¶ä»»åŠ¡ã€‚

# å¼‚æ­¥ä»»åŠ¡

å…¥é—¨æ–‡æ¡£:  https://www.iocoder.cn/Spring-Boot/Async-Job/?yudao

1. åœ¨ä¸»å…¥å£å¼€å¯å¼‚æ­¥ä»»åŠ¡é…ç½®
```java
@EnableAsync //å¼€å¯å¼‚æ­¥æ³¨è§£
@SpringBootApplication
public class SpringbootApplication {
	public static void main(String[] args) {
		SpringApplication.run(SpringbootApplication.class, args);
	}
}
```

2. é€šè¿‡`@Async`å£°æ˜ä¸€ä¸ªå¼‚æ­¥ä»»åŠ¡
```java
@Service
public class TeskService {
    @Async
    public void asyncService(){
        System.out.println("å¼‚æ­¥ä»»åŠ¡å¤„ç†æ•°æ®");
    }
}
```

3. å¼‚æ­¥ä»»åŠ¡é…ç½®(ä¹Ÿå°±æ˜¯é…ç½®ä»»åŠ¡çš„çº¿ç¨‹æ± ï¼Œä¹Ÿå¯ä»¥ç”¨é»˜è®¤çš„)

   ```yaml
   spring:
     task:
       # Spring æ‰§è¡Œå™¨é…ç½®ï¼Œå¯¹åº” TaskExecutionProperties é…ç½®ç±»ã€‚å¯¹äº Spring å¼‚æ­¥ä»»åŠ¡ï¼Œä¼šä½¿ç”¨è¯¥æ‰§è¡Œå™¨ã€‚
       execution:
         thread-name-prefix: task- # çº¿ç¨‹æ± çš„çº¿ç¨‹åçš„å‰ç¼€ã€‚é»˜è®¤ä¸º task- ï¼Œå»ºè®®æ ¹æ®è‡ªå·±åº”ç”¨æ¥è®¾ç½®
         pool: # çº¿ç¨‹æ± ç›¸å…³
           core-size: 8 # æ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œçº¿ç¨‹æ± åˆ›å»ºæ—¶å€™åˆå§‹åŒ–çš„çº¿ç¨‹æ•°ã€‚é»˜è®¤ä¸º 8 ã€‚
           max-size: 20 # æœ€å¤§çº¿ç¨‹æ•°ï¼Œçº¿ç¨‹æ± æœ€å¤§çš„çº¿ç¨‹æ•°ï¼Œåªæœ‰åœ¨ç¼“å†²é˜Ÿåˆ—æ»¡äº†ä¹‹åï¼Œæ‰ä¼šç”³è¯·è¶…è¿‡æ ¸å¿ƒçº¿ç¨‹æ•°çš„çº¿ç¨‹ã€‚é»˜è®¤ä¸º Integer.MAX_VALUE
           keep-alive: 60s # å…è®¸çº¿ç¨‹çš„ç©ºé—²æ—¶é—´ï¼Œå½“è¶…è¿‡äº†æ ¸å¿ƒçº¿ç¨‹ä¹‹å¤–çš„çº¿ç¨‹ï¼Œåœ¨ç©ºé—²æ—¶é—´åˆ°è¾¾ä¹‹åä¼šè¢«é”€æ¯ã€‚é»˜è®¤ä¸º 60 ç§’
           queue-capacity: 200 # ç¼“å†²é˜Ÿåˆ—å¤§å°ï¼Œç”¨æ¥ç¼“å†²æ‰§è¡Œä»»åŠ¡çš„é˜Ÿåˆ—çš„å¤§å°ã€‚é»˜è®¤ä¸º Integer.MAX_VALUE ã€‚
           allow-core-thread-timeout: true # æ˜¯å¦å…è®¸æ ¸å¿ƒçº¿ç¨‹è¶…æ—¶ï¼Œå³å¼€å¯çº¿ç¨‹æ± çš„åŠ¨æ€å¢é•¿å’Œç¼©å°ã€‚é»˜è®¤ä¸º true ã€‚
         shutdown:
           await-termination: true # åº”ç”¨å…³é—­æ—¶ï¼Œæ˜¯å¦ç­‰å¾…å®šæ—¶ä»»åŠ¡æ‰§è¡Œå®Œæˆã€‚é»˜è®¤ä¸º false ï¼Œå»ºè®®è®¾ç½®ä¸º true
           await-termination-period: 60 # ç­‰å¾…ä»»åŠ¡å®Œæˆçš„æœ€å¤§æ—¶é•¿ï¼Œå•ä½ä¸ºç§’ã€‚é»˜è®¤ä¸º 0 ï¼Œæ ¹æ®è‡ªå·±åº”ç”¨æ¥è®¾ç½®
   ```

   - åœ¨ `spring.task.execution` é…ç½®é¡¹ï¼ŒSpring Task è°ƒåº¦ä»»åŠ¡çš„é…ç½®ï¼Œå¯¹åº” [TaskExecutionProperties](https://github.com/spring-projects/spring-boot/blob/master/spring-boot-project/spring-boot-autoconfigure/src/main/java/org/springframework/boot/autoconfigure/task/TaskExecutionProperties.java) é…ç½®ç±»ã€‚
   - Spring Boot [TaskExecutionAutoConfiguration](https://github.com/spring-projects/spring-boot/blob/master/spring-boot-project/spring-boot-autoconfigure/src/main/java/org/springframework/boot/autoconfigure/task/TaskExecutionAutoConfiguration.java) è‡ªåŠ¨åŒ–é…ç½®ç±»ï¼Œå®ç° Spring Task çš„è‡ªåŠ¨é…ç½®ï¼Œåˆ›å»º [ThreadPoolTaskExecutor](https://github.com/spring-projects/spring-framework/blob/master/spring-context/src/main/java/org/springframework/scheduling/concurrent/ThreadPoolTaskExecutor.java) åŸºäºçº¿ç¨‹æ± çš„ä»»åŠ¡æ‰§è¡Œå™¨ã€‚æœ¬è´¨ä¸Šï¼ŒThreadPoolTaskExecutor æ˜¯åŸºäº ThreadPoolExecutor çš„å°è£…ï¼Œä¸»è¦å¢åŠ æäº¤ä»»åŠ¡ï¼Œè¿”å› **ListenableFuture** å¯¹è±¡çš„åŠŸèƒ½ã€‚

4. å¼‚æ­¥å¼‚å¸¸å¤„ç†å™¨

   ç»Ÿä¸€å¤„ç†å¼‚æ­¥ä»»åŠ¡äº§ç”Ÿçš„å¼‚å¸¸

```java
@Component
public class GlobalAsyncExceptionHandler implements AsyncUncaughtExceptionHandler {

    private Logger logger = LoggerFactory.getLogger(getClass());

    @Override
    public void handleUncaughtException(Throwable ex, Method method, Object... params) {
        logger.error("[handleUncaughtException][method({}) params({}) å‘ç”Ÿå¼‚å¸¸]",
                method, params, ex);
    }

}
```

5 AsyncConfig

åˆ›å»º [AsyncConfig](https://github.com/YunaiV/SpringBoot-Labs/blob/master/lab-29/lab-29-async-demo/src/main/java/cn/iocoder/springboot/lab29/asynctask/config/AsyncConfig.java) ç±»ï¼Œé…ç½®å¼‚å¸¸å¤„ç†å™¨ã€‚ä»£ç å¦‚ä¸‹ï¼š

```java
// AsyncConfig.java

@Configuration
@EnableAsync // å¼€å¯ @Async çš„æ”¯æŒ
public class AsyncConfig implements AsyncConfigurer {

    @Autowired
    private GlobalAsyncExceptionHandler exceptionHandler;

    @Override
    public Executor getAsyncExecutor() {
        return null;
    }

    @Override
    public AsyncUncaughtExceptionHandler getAsyncUncaughtExceptionHandler() {
        return exceptionHandler;
    }

}
```



- åœ¨ç±»ä¸Šæ·»åŠ  [`@EnableAsync`](https://github.com/spring-projects/spring-framework/blob/master/spring-context/src/main/java/org/springframework/scheduling/annotation/EnableAsync.java) æ³¨è§£ï¼Œå¯ç”¨å¼‚æ­¥åŠŸèƒ½ã€‚è¿™æ ·[ã€Œ2. Applicationã€](https://www.iocoder.cn/Spring-Boot/Async-Job/?yudao#) çš„ `@EnableAsync` æ³¨è§£ï¼Œä¹Ÿå°±å¯ä»¥å»æ‰äº†ã€‚
- å®ç° [AsyncConfigurer](https://github.com/spring-projects/spring-framework/blob/master/spring-context/src/main/java/org/springframework/scheduling/annotation/AsyncConfigurer.java) æ¥å£ï¼Œå®ç°å¼‚æ­¥ç›¸å…³çš„å…¨å±€é…ç½®ã€‚ğŸ˜ˆ æ­¤æ—¶æ­¤åˆ»ï¼Œèƒ–å‹æœ‰æ²¡æƒ³åˆ° SpringMVC çš„ [WebMvcConfigurer](https://github.com/spring-projects/spring-framework/blob/master/spring-webmvc/src/main/java/org/springframework/web/servlet/config/annotation/WebMvcConfigurer.java) æ¥å£ã€‚
- å®ç° `#getAsyncUncaughtExceptionHandler()` æ–¹æ³•ï¼Œè¿”å›æˆ‘ä»¬å®šä¹‰çš„ GlobalAsyncExceptionHandler å¯¹è±¡ã€‚
- å®ç° `#getAsyncExecutor()` æ–¹æ³•ï¼Œè¿”å› Spring Task å¼‚æ­¥ä»»åŠ¡çš„**é»˜è®¤æ‰§è¡Œå™¨**ã€‚è¿™é‡Œï¼Œæˆ‘ä»¬è¿”å›äº† `null` ï¼Œå¹¶æœªå®šä¹‰é»˜è®¤æ‰§è¡Œå™¨ã€‚æ‰€ä»¥æœ€ç»ˆä¼šä½¿ç”¨ [TaskExecutionAutoConfiguration](https://github.com/spring-projects/spring-boot/blob/master/spring-boot-project/spring-boot-autoconfigure/src/main/java/org/springframework/boot/autoconfigure/task/TaskExecutionAutoConfiguration.java) è‡ªåŠ¨åŒ–é…ç½®ç±»åˆ›å»ºå‡ºæ¥çš„ ThreadPoolTaskExecutor ä»»åŠ¡æ‰§è¡Œå™¨ï¼Œä½œä¸ºé»˜è®¤æ‰§è¡Œå™¨ã€‚

# å®šæ—¶ä»»åŠ¡

1. ç¨‹åºä¸»å…¥å£å¼€å¯å®šæ—¶ä»»åŠ¡
```java
@EnableScheduling  //å¼€å¯åŸºäºæ³¨è§£çš„å®šæ—¶ä»»åŠ¡
@SpringBootApplication
public class SpringbootApplication {
	public static void main(String[] args) {
		SpringApplication.run(SpringbootApplication.class, args);
	}
}
```

2. é…ç½®å®šæ—¶ä»»åŠ¡
```java

@Service
public class TeskService {
    @Scheduled(cron="0/4 * * * * *")
    public void timeService(){
        System.out.println("æ¯4ç§’æ‰§è¡Œä¸€æ¬¡ï¼Œæ‰§è¡Œå®šæ—¶å™¨äº†ï¼");
    }

}
```
3. cronçš„è¡¨è¾¾å¼è¯´æ˜
* cornè¡¨è¾¾æ˜¯ç”±6ä½ç»„æˆï¼Œ*è¡¨ç¤ºæ‰€æœ‰ã€‚
6å°¾æ•°åˆ†åˆ«è¡¨ç¤ºè¿™å‡ ä¸ªæ—¶é—´
second(ç§’), minuteï¼ˆåˆ†ï¼‰, hourï¼ˆæ—¶ï¼‰, day of monthï¼ˆæ—¥ï¼‰, monthï¼ˆæœˆï¼‰, day of weekï¼ˆå‘¨å‡ ï¼‰

1. cornè¡¨è¾¾æ˜¯å„ä¸ªå­—æ®µçš„å…è®¸å€¼
|å­—æ®µ|å…è®¸å€¼|å…è®¸çš„ç‰¹æ®Šç¬¦å·|
|:----|:------|-------|
|ç§’ |0-59 |, - * /|
|åˆ† |0-59 |, - * /|
|å°æ—¶ |0-23| , - * /|
|æ—¥æœŸ |1-31 |, - * ? / L W C|
|æœˆä»½ |1-12| , - * /|
|æ˜ŸæœŸ| 0-7æˆ–SUN-SAT 0,7æ˜¯SUN |, - * ? / L C #|

2. ç‰¹æ®Šç¬¦å·ä»£è¡¨çš„å«ä¹‰
|ç¬¦å·|å«ä¹‰|
|----|----|
|, |æšä¸¾|
|- |åŒºé—´|
|* |ä»»æ„|
|/ |æ­¥é•¿|
|? |æ—¥/æ˜ŸæœŸå†²çªåŒ¹é…   åªèƒ½ç”¨åœ¨DayofMonthå’ŒDayofWeekä¸¤ä¸ªåŸŸã€‚å®ƒä¹ŸåŒ¹é…åŸŸçš„ä»»æ„å€¼ï¼Œä½†å®é™…ä¸ä¼šã€‚å› ä¸ºDayofMonthå’Œ DayofWeekä¼šç›¸äº’å½±å“ã€‚ä¾‹å¦‚æƒ³åœ¨æ¯æœˆçš„20æ—¥è§¦å‘è°ƒåº¦ï¼Œä¸ç®¡20æ—¥åˆ°åº•æ˜¯æ˜ŸæœŸå‡ ï¼Œåˆ™åªèƒ½ä½¿ç”¨å¦‚ä¸‹å†™æ³•ï¼š 13 13 15 20 * ?, å…¶ä¸­æœ€åä¸€ä½åªèƒ½ç”¨ï¼Ÿï¼Œè€Œä¸èƒ½ä½¿ç”¨ `*`ï¼Œå¦‚æœä½¿ç”¨`*`è¡¨ç¤ºä¸ç®¡æ˜ŸæœŸå‡ éƒ½ä¼šè§¦å‘ï¼Œå®é™…ä¸Šå¹¶ä¸æ˜¯è¿™æ ·ã€‚|
|L |æœ€å|
|W |å·¥ä½œæ—¥|
|C |å’Œcalendarè”ç³»åè®¡ç®—è¿‡çš„å€¼|
|# |æ˜ŸæœŸï¼Œ4#2ï¼Œç¬¬2ä¸ªæ˜ŸæœŸå››|

* ä¸€äº›ä¾‹å­ç”¨äºè§£é‡Š
```java
ã€0 0/5 14,18 * * ?ã€‘ æ¯å¤©14ç‚¹æ•´ï¼Œå’Œ18ç‚¹æ•´ï¼Œæ¯éš”5åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡
ã€0 15 10 ? * 1-6ã€‘ æ¯ä¸ªæœˆçš„å‘¨ä¸€è‡³å‘¨å…­10:15åˆ†æ‰§è¡Œä¸€æ¬¡
ã€0 0 2 ? * 6Lã€‘æ¯ä¸ªæœˆçš„æœ€åä¸€ä¸ªå‘¨å…­å‡Œæ™¨2ç‚¹æ‰§è¡Œä¸€æ¬¡
ã€0 0 2 LW * ?ã€‘æ¯ä¸ªæœˆçš„æœ€åä¸€ä¸ªå·¥ä½œæ—¥å‡Œæ™¨2ç‚¹æ‰§è¡Œä¸€æ¬¡
ã€0 0 2-4 ? * 1#1ã€‘æ¯ä¸ªæœˆçš„ç¬¬ä¸€ä¸ªå‘¨ä¸€å‡Œæ™¨2ç‚¹åˆ°4ç‚¹æœŸé—´ï¼Œæ¯ä¸ªæ•´ç‚¹éƒ½æ‰§è¡Œä¸€æ¬¡ï¼›
ã€0 * * * * MON-SATã€‘æ˜ŸæœŸä¸€åˆ°æ˜ŸæœŸ6  æ¯åˆ°æ•´ç§’éƒ½æ‰§è¡Œ
ã€0,1,2,3,4 * * * * MON-SATã€‘æ˜ŸæœŸä¸€åˆ°æ˜ŸæœŸ6  æ¯åˆ°æ•´0ï¼Œ1ï¼Œ2ï¼Œ3ï¼Œ4ç§’éƒ½æ‰§è¡Œ0-4 è¿™ä¸ªåŒç†
```

# é‚®ä»¶ä»»åŠ¡
1. åœ¨pom.xmlé‡Œé¢å¼•å…¥é‚®ä»¶å¯åŠ¨å™¨
```xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-mail</artifactId>
</dependency>
```

2. åœ¨é…ç½®æ–‡ä»¶é‡Œé¢é…ç½®ç›¸åº”ä¿¡æ¯
```yaml
spring:
  mail:
    #ç”¨æˆ·å
    username: 1227900499@qq.com
    #è¿™ä¸ªå¯†ç ä¸æ˜¯é‚®ç®±çš„ç™»å½•å¯†ç ï¼Œéœ€è¦åœ¨é‚®ç®±æœåŠ¡å™¨é‡Œé¢å»ç”Ÿæˆçš„æˆæƒå—ï¼Œqqé‚®ç®±åœ¨qq é‡Œé¢çš„ è®¾ç½®-->è´¦æˆ·é‡Œé¢
    password: xxxxxxx
    #qqæœåŠ¡å™¨æ˜¯ä¸‹é¢è¿™ä¸ªï¼Œå…¶ä»–çš„æœåŠ¡å™¨éœ€è¦åˆ°ç›¸åº”çš„åœ°æ–¹å»æ‰¾ï¼Œqq qqåœ¨QQé‚®ç®±---->è®¾ç½®---è´¦æˆ·é‡Œé¢å»æ‰¾
    host: smtp.qq.com

```

3. äº‹ä¾‹ä»£ç 
```java
@Autowired
JavaMailSenderImpl mailSender;

//ç®€å•é‚®ä»¶æµ‹è¯•
@Test
public void sendMailTest() {
    SimpleMailMessage message = new SimpleMailMessage();
    //è®¾ç½®é‚®ä»¶çš„åŸºæœ¬ä¿¡æ¯
    message.setSubject("ç®€å•é‚®ä»¶å‘é€æµ‹è¯•");
    message.setText("æˆ‘æ˜¯æµ‹è¯•å†…å®¹");

    message.setTo("325811402@qq.com");
    message.setFrom("1227900499@qq.com");

    mailSender.send(message);
}

//å¸¦æ–‡ä»¶çš„é‚®ä»¶å‘é€æµ‹è¯•
@Test
public void sendMailTest2() throws  Exception{
    //1ã€åˆ›å»ºä¸€ä¸ªå¤æ‚çš„æ¶ˆæ¯é‚®ä»¶
    MimeMessage mimeMessage = mailSender.createMimeMessage();
    MimeMessageHelper helper = new MimeMessageHelper(mimeMessage, true);

    //é‚®ä»¶è®¾ç½®
    helper.setSubject("é‚®ä»¶æµ‹è¯•");
    //å¯ä»¥åŠ html æ ‡ç­¾ï¼Œå•ç¬¬äºŒä¸ªå‚æ•°è¦ä¸ºtrue ,æŠŠhtml æ ‡ç­¾åŠŸèƒ½å¼€å¯
    helper.setText("<b style='color:red'>é‚®ä»¶æµ‹è¯•ç±»å®¹ï¼Œå¯ä»¥åŠ æ ‡ç­¾å“¦</b>ï¼Œå“ˆå“ˆ",true);

    helper.setTo("325811402@qq.com");
    helper.setFrom("1227900499@qq.com");

    //ä¸Šä¼ æ–‡ä»¶
    helper.addAttachment("1.jpg",new File("C:\\Users\\Administrator.BF-20180801KGCC\\Desktop\\å¤´åƒ\\1.jpg"));
    helper.addAttachment("2.jpg",new File("C:\\Users\\Administrator.BF-20180801KGCC\\Desktop\\å¤´åƒ\\2.jpg"));

    mailSender.send(mimeMessage);
}
```