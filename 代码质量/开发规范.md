# 开发规范

代码规范是使得代码达到可读的关键。由于Java这个语言在发明的时候并没有考虑到语法和规范的统一，因此，在编写Java代码或者架构Java项目时很多人都有着自己一套个性的风格。对于一个团队来说，这并不可取。于是，很多大公司慢慢演化出了自己的一套编码规范。比较出名的有Google和阿里的Java编码规范。

# 最为需要遵循的Java编码规范。

1. 变量命名按照Java通用方式Camel命名法。常量尤其注意使用全大写_下划线连接单词的方式，如 USER_KEY。
1. 变量和类命名务必具有意义，能让人一眼看出表示的意思。如userList表示用户列表，不要使用list、set、button这种无意义的命名方式。
1. 当一个方法的主逻辑代码超过30行(经验值)，务必考虑封装方法或者类。
1. 类内方法定义的顺序依照开发者的关心程度和承载的信息价值依次是:公有方法或保护方法、私有方法、getter/setter方法。
1. 数据领域类POJO的字段
    - "不会为空"时使用基本数据类型，需要注意字段默认值不能具有特殊意义。
    - "可为空"时使用包装类型，需要做好空值判断。
1. 方法尤其是对外提供的接口（RPC、SDK）如果返回值可能为空，务必使用Optional包装返回值，否则认为返回值不会为空。
1. “异常”编码规范
    - 优先考虑使用错误码返回值而不是异常表示错误：用错误码返回值处理可能会发生的事情，用异常捕捉处理不期望发生的事情
    - 在抛出异常时，需要尽可能精确地描述问题和相关信息。如：尽可能的使用最具体的异常来声明方法，这样才能使得代码更容易理解。
    - 当在方法上声明抛出异常时，需要进行文档说明。在Javadoc中加入throws声明，描述抛出异常的场景。
    - 不要捕获Throwable。
    - 不要忽略异常，至少要记录异常的信息。
    - 不要记录并抛出异常。仅仅当想要处理异常时才去捕获，否则只需要在方法签名中声明让调用者去处理。
    - 包装异常时不要抛弃原始的异常。一定要把原始的异常设置为cause(Exception有构造方法可以传入cause)。
1. MVC规范
    - 数据库的一个表对应一个领域类，以entity、domain或者meta做为包名都可以。
    - 数据访问层命名形如xxxDao，这里应该封装所有与数据库层相关的东西，如表名、各个列等。
    - controller或者servlet中不要掺杂复杂业务逻辑代码（放到service中）
    - service类是封装业务逻辑的类，其中的方法要和此业务逻辑相关。比如UserService就是和User相关的业务方法。
    - 当一个东西具有缓存和实际值两种的时候，务必保证存储和获取的接口只有一个。比如获取用户的level，应该只在UserLevelService中暴露一个接口提供

对于这些规范，可以使用`CheckStyle`、`PMD`、`FindBugs`等工具进行保证，使用相关的Maven插件即可。此外，阿里巴巴也推出了其Java编码规范对应的Intellij插件。

- CheckStyle: 检查Java源文件是否与代码规范相符，主要包括：
    - Javadoc注释
    - 命名规范
    - 多余没用的Imports
    - Size度量，如过长的方法
    - 缺少必要的空格Whitespace
    - 重复代码
    
    默认规范过于严格，可以参考这个文件做自定义规则：<https://github.com/superhj1987/awesome-libs/blob/master/doc/checkstyle-checks.xml>。
    
- PMD:检查**Java源文件**中的潜在问题,主要包括：
    - 空try/catch/finally/switch语句块
    - 未使用的局部变量、参数和private方法
    - 空if/while语句
    - 过于复杂的表达式，如不必要的if语句等
    - 复杂类

    默认规范比较严格，可以参考这个文件做自定义规则：<https://github.com/superhj1987/awesome-libs/blob/master/doc/pmdrule.xml>。
    
- FindBugs: 基于Bug Patterns概念，查找**Java字节码（.class文件）**中的潜在bug。主要检查bytecode中的Bug Patterns，如NullPointerException、没有合理关闭资源、字符串相同判断错（==，而不是equals）等。大多数提示有用，值得改。可以借鉴此文件，忽略一些不必要的规则：<https://github.com/superhj1987/awesome-libs/blob/master/doc/findbugs-exclude.xml>。

虽然以上工具已经可以告警不符合规范的代码，但仍然需要通过团队成员之间的Code Review才能够进一步保证开发规范的实践。

# 建议

1. 务必撰写文档，尤其对于一些逻辑复杂的项目或者模块，需要包括以下文档：项目/模块的介绍文档；QuickStart，按照文档说明应该能在一小时内完成代码构建和简单使用；详细说明文档，比如主要逻辑流程、接口定义、参数含义、设计等。
1. 在代码无法阐述设计意图的时候，注释是必须的。但注释不宜过多，过多意味着代码的可读性有问题。
1. 防御性编程：做好对异常的处理，不要相信任何外部输入和依赖。
1. 接着上一条，对于所有外部调用以及内部服务调用都要做容错和超时处理。不管是RPC调用还是对于第三方服务的调用，都不能想当然的认为可用性是100%的。不允许出现服务调用超时和重试，将会对应用程序的稳定性和性能造成不利的影响。
1. 分离可靠操作和不可靠操作: 可靠操作指的是不会抛出异常或引起状态不一致，比如，操作一个Map，可以认为是可靠的，而读写数据库、调用第三方服务等，可以认为是不可靠的。在代码中尽量划分开，对不可靠的操作的失败做异常处理。
1. 简洁与抽象：最好的代码抽象，是对现实概念的映射。即只要有相关知识，每个类的作用都能第一时间明白其作用。但万万不要过度抽象，过度的抽象反而会降低代码质量。
1. 代码的可复用：代码的可复用是优秀工程师的一个本能。但切记不能为了复用而复用。
1. 程序需要状态，对象不需要状态，如果对象有了状态，就会引发多线程问题。程序的状态应该统一由数据库、缓存、任务队列这些外部容器来容纳，处理时以局部变量的形式在线程内部流转直至被回收。
1. 在做商业计算时（金融、电商交易），务必要注意选择的数据类型的存储数值范围，防止用户传入的数值溢出造成归零或者负值，从而造成交易损失。比如直播平台用户送礼物的场景，设计的接口的参数为礼物ID和礼物数目。那么如果使用int类型计算总的花费，当礼物数目非常大的时候就会造成花费超出int的存储范围而溢出为<=0的值，使得用户可以无限送礼物。
1. 编码时，在每次调用一个方法时多考虑以下问题：

    - 会不会出现空指针？
    - 有没有异常抛出？
    - 有没有并发锁间隙？
    - 会不会并发修改不可见？